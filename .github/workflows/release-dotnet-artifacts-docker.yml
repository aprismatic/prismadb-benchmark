name: Release .NET Artifacts and Docker Images

on:
  release:
    types: [created]

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v2
    - name: Setup nuget
      uses: nuget/setup-nuget@v1
    - name: Restore packages
      run: nuget restore
    - name: Publish with dotnet
      run: |
        dotnet publish --configuration Release --no-restore -p:Version=${{ github.event.release.tag_name }} --output "./publish/"
    - name: Upload artifacts
      uses: actions/upload-artifact@v1
      with:
        name: publish
        path: ./publish
    - name: Zip binaries with 7zip
      run: |
        7z a PrismaDB.Benchmark.${{ github.event.release.tag_name }}.zip ./publish/*
    - name: Upload release binaries
      uses: skx/github-action-publish-binaries@master
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        args: 'PrismaDB.Benchmark.*.zip'

  publish_docker:
    needs: publish
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v2
    - name: Download artifacts
      uses: actions/download-artifact@v1
      with:
        name: publish
        path: ./publish
    - name: Login to ACR
      run: |
        docker login -u prismadb -p ${{ secrets.AzureRegistryPassword }} prismadb.azurecr.io
      shell: pwsh
    - name: Build and Push Docker images
      run: ./ci/build-push.ps1
      shell: pwsh
      env:
        VERSION: ${{ github.event.release.tag_name }}